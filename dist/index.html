<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>when-to-water</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-0evHe/X+R7YkIZDRvuzKMRqM+OrBnVFBL6DOitfPri4tjfHxaWutUpFmBp4vmVor" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.3/font/bootstrap-icons.css">
</head>

<body>
    <main>
        <div class="container">
            <div class="px-4 py-4 mt-3 mb-5 text-center rounded-3 border shadow-lg">
                <img class="d-block mx-auto mb-4" src="images/watering-plants.png" alt="" width="128" height="128">
                <h1 class="display-4 fw-bold">when-to-water <span class="badge rounded-pill bg-danger">
                        pre-alpha</span>
                </h1>
                <div class="col-lg-6 mx-auto">
                    <p class="lead mb-4">A website to tell you when to water your plants. Created for the course
                        <strong>Anwendungsprojekt</strong> at the <a href="https://www.fom.de/" rel="nofollow">FOM
                            Hochschule</a> by <a href="https://github.com/BeneKenobi">@BeneKenobi</a>, <a
                            href="https://github.com/Mekcyed">@Mekcyed</a> and <a
                            href="https://github.com/Sharakh69">@Sharakh69</a>.
                    </p>
                </div>

                <hr class="col-lg-6 mx-auto my-5">
                <div class="col-lg-6 mx-auto">
                    <h2 class="display-6 fw-bold">Select wanted moisture in %</h2>
                </div>
                <div class="col-lg-8 mx-auto">
                    <form>
                        <div class="row">
                            <div class="col">
                                <label for="inputPilea">Pilea</label>
                                <input type="number" class="form-control" id="inputPilea" value="50" min="0" max="100">
                            </div>
                            <div class="col">
                                <label for="inputDrachenbaum">Drachenbaum</label>
                                <input type="number" class="form-control" id="inputDrachenbaum" value="50" min="0"
                                    max="100">
                            </div>
                            <div class="col">
                                <label for="inputGoldfruchtpalme">Goldfruchtpalme</label>
                                <input type="number" class="form-control" id="inputGoldfruchtpalme" value="50" min="0"
                                    max="100">
                            </div>
                        </div>
                    </form>
                    <button type="button" class="btn btn-primary mt-3" id="refreshButton">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                            class="bi bi-arrow-down-up" viewBox="0 0 16 16">
                            <path fill-rule="evenodd"
                                d="M11.5 15a.5.5 0 0 0 .5-.5V2.707l3.146 3.147a.5.5 0 0 0 .708-.708l-4-4a.5.5 0 0 0-.708 0l-4 4a.5.5 0 1 0 .708.708L11 2.707V14.5a.5.5 0 0 0 .5.5zm-7-14a.5.5 0 0 1 .5.5v11.793l3.146-3.147a.5.5 0 0 1 .708.708l-4 4a.5.5 0 0 1-.708 0l-4-4a.5.5 0 0 1 .708-.708L4 13.293V1.5a.5.5 0 0 1 .5-.5z">
                            </path>
                        </svg>
                        Refresh
                    </button>
                    <div class="col-lg-5 mx-auto mt-3">
                        <div class="progress" id="loadingBar" style="display: none;"></div>
                    </div>
                </div>
                <hr class="col-lg-6 mx-auto my-5">
                <div class="col-lg-6 mx-auto">
                    <h2 class="display-6 fw-bold">Results</h2>
                </div>
                <div class="col-lg-10 py-2 mx-auto text-center">
                    <div class="row g-1 row-cols-1 row-cols-lg-3" id="plant_details">
                        <div class="feature col border px-0" id="pilea_details">
                            <h3 class="display-7 fw-bold py-2">
                                Pilea
                            </h3>
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item" id="pilea_watering">
                                    <p class="placeholder-glow">
                                        <span class="placeholder col-8"></span>
                                    </p>
                                </li>
                                <li class="list-group-item" id="pilea_last_measurement">
                                    <p class="placeholder-glow">
                                        <span class="placeholder col-8"></span>
                                    </p>
                                </li>
                                <li class="list-group-item" id="pilea_predicted_moisture">
                                    <p class="placeholder-glow">
                                        <span class="placeholder col-8"></span>
                                    </p>
                                </li>
                            </ul>
                        </div>
                        <div class="feature col border px-0" id="drachenbaum_details">
                            <h3 class="display-7 fw-bold py-2">
                                Drachenbaum
                            </h3>
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item" id="drachenbaum_watering">
                                    <p class="placeholder-glow">
                                        <span class="placeholder col-8"></span>
                                    </p>
                                </li>
                                <li class="list-group-item" id="drachenbaum_last_measurement">
                                    <p class="placeholder-glow">
                                        <span class="placeholder col-8"></span>
                                    </p>
                                </li>
                                <li class="list-group-item" id="drachenbaum_predicted_moisture">
                                    <p class="placeholder-glow">
                                        <span class="placeholder col-8"></span>
                                    </p>
                                </li>
                            </ul>
                        </div>
                        <div class="feature col border px-0" id="goldfruchtpalme_details">
                            <h3 class="display-7 fw-bold py-2">
                                Goldfruchtpalme
                            </h3>
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item" id="goldfruchtpalme_watering">
                                    <p class="placeholder-glow">
                                        <span class="placeholder col-8"></span>
                                    </p>
                                </li>
                                <li class="list-group-item" id="goldfruchtpalme_last_measurement">
                                    <p class="placeholder-glow">
                                        <span class="placeholder col-8"></span>
                                    </p>
                                </li>
                                <li class="list-group-item" id="goldfruchtpalme_predicted_moisture">
                                    <p class="placeholder-glow">
                                        <span class="placeholder col-8"></span>
                                    </p>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
                <hr class="col-lg-6 mx-auto my-5">
                <div class="col-lg-6 mx-auto">
                    <h2 class="display-6 fw-bold">Last week moisture</h2>
                </div>
                <div class="col-lg-8 mx-auto text-center">
                    <canvas id="plantChart" height="415px"></canvas>
                </div>
            </div>
            <div class="blockquote-footer text-end"><a href="https://www.flaticon.com/free-icons/plant"
                    title="plant icons">Plant icons created by Freepik - Flaticon</a></div>
        </div>
        <div class="modal fade" id="errorModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="errorModalTitle">Error</h5>
                </div>
                <div class="modal-body" id="errorModalBody">
                  ...
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-primary" onclick="location.reload();">Reload</button>
                </div>
              </div>
            </div>
          </div>
          
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-pprn3073KE6tl6bjs2QrFaJGz5/SUsLqktiwsUTF55Jfv3qYSDhgCecCxMW52nD2"
            crossorigin="anonymous"></script>
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"
            integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.8.0/chart.min.js"
            integrity="sha512-sW/w8s4RWTdFFSduOTGtk4isV1+190E/GghVffMA9XczdJ2MDzSzLEubKAs5h0wzgSJOQTRYyaz73L3d6RtJSg=="
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>
        <script src="https://cdn.jsdelivr.net/npm/luxon@2.4.0/build/global/luxon.min.js"
            integrity="sha256-DIsAGD2EF8Qq2PCH9yzX/yt9FliJfWf+aGcdgR6tKwo=" crossorigin="anonymous"></script>
        <script>
            var DateTime = luxon.DateTime;
            const NOW = DateTime.now()
            const COLORS = [
                "#E69F00",
                "#56B4E9",
                "#009E73",
                "#F0E442",
                "#0072B2",
                "#D55E00",
                "#CC79A7",
            ];
            const PLANTS = [
                "Pilea",
                "Drachenbaum",
                "Goldfruchtpalme",
            ];

            let resultData = {};
            let loadState = 0;
            let plantChart;
            let errorModal;

            function last8Days() {
                var result = [];
                for (var i = 0; i < 8; i++) {
                    result.push(NOW.minus({ days: i }).toISODate());
                }

                return (result.reverse());
            }

            function setLoading() {
                $('#refreshButton').prop("disabled", true);
                resultData = {};
                $("#plant_details div ul li").html('<p class="placeholder-glow"><span class="placeholder col-8"></span></p>');
                $("#plant_details div ul li").removeClass("list-group-item-success list-group-item-warning list-group-item-danger");
                $("#loadingBar").show("slow")
                $("#loadingBar").html('<div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%"></div>')
                loadState = 10;
                $("#loadingBar div").attr("aria-valuenow", loadState).css("width", loadState + "%")
                plantChart.data.datasets = [];
                plantChart.update()
            }

            function handleError(text) {
                $('#errorModalBody').html(`<p>${text}</p>`)
                errorModal.show()
            }

            function setPlantDetails(plant) {
                let watering = Math.round(resultData[plant].next_watering);
                let level = "";
                if (watering < 0) {
                    watering = `${Math.abs(watering)} day(s) ago`
                    level = "danger"
                } else if (watering < 1) {
                    watering = 'today'
                    level = "warning"
                } else {
                    watering = `in ${watering} day(s)`
                    level = "success"
                }
                $(`#${plant.toLowerCase()}_watering`).html(`<b>Next watering:</b> ${watering}`).addClass(`list-group-item-${level}`);

                last_measurement_diff = DateTime.fromSeconds(resultData[plant].last_measuring.time).toRelative({ locale: "en" })
                $(`#${plant.toLowerCase()}_last_measurement`).html(`<b>Last measured soil moisture:</b> ${resultData[plant].last_measuring.value}&nbsp;% <span class="badge rounded-pill text-bg-secondary">${last_measurement_diff}</span>`);

                $(`#${plant.toLowerCase()}_predicted_moisture`).html(`<b>Current soil moisture:</b> ${resultData[plant].predicted_moisture.toFixed(1)}&nbsp;% <span class="badge rounded-pill text-bg-primary">predicted</span>`);
            }

            function addDataToChart(plantData) {
                plant = Object.keys(plantData)[0]

                let plantDataLength = plantData[plant].last_week_moistures.length
                let dataPoints = plantData[plant].last_week_moistures
                if (plantDataLength > 0) {
                    if (plantDataLength == 7 && DateTime.fromSeconds(plantData[plant].last_measuring.time).toISODate() === DateTime.local().toISODate()) {
                        datapoints.push[plantData[plant].last_measuring.value]
                    }
                    const data = plantChart.data;
                    const dsColor = COLORS[plantChart.data.datasets.length];
                    let newDataset = {
                        label: plant,
                        backgroundColor: dsColor,
                        borderColor: dsColor,
                        data: dataPoints,
                        fill: false,
                        cubicInterpolationMode: 'monotone',
                        tension: 0.1
                    };
                    plantChart.data.datasets.push(newDataset);
                    plantChart.update();

                    if (dataPoints.length < 8) {
                        let latestMoisture = plantData[plant].last_week_moistures.slice(-1)
                        let predictedMoisture = plantData[plant].predicted_moisture
                        let predictionPoints = Array(7).fill(null);
                        predictionPoints[dataPoints.length-1] = latestMoisture
                        predictionPoints.push(predictedMoisture.toFixed(1))
                        newDataset = {
                            label: plant + " predicted",
                            backgroundColor: dsColor,
                            borderColor: dsColor,
                            data: predictionPoints,
                            fill: false,
                            borderDash: [5, 5],
                            cubicInterpolationMode: 'monotone',
                            tension: 0.1,
                            spanGaps: true,
                        };
                        plantChart.data.datasets.push(newDataset);
                        plantChart.update();
                    }
                }
            }

            function getPlantData() {
                setLoading();
                resultData = {};
                const url = "https://awdoshiafdfteasrlnsp2cwwte0qphrd.lambda-url.eu-central-1.on.aws/";
                inputDataPilea = {
                    "Pilea": $('#inputPilea').val()
                }
                inputDataDrachenbaum = {
                    "Drachenbaum": $('#inputDrachenbaum').val()
                }
                inputDataGoldfruchtpalme = {
                    "Goldfruchtpalme": $('#inputGoldfruchtpalme').val()
                }
                $.when(
                    $.ajax(url, {
                        data: JSON.stringify(inputDataPilea),
                        contentType: 'application/json',
                        type: 'POST',
                        timeout: 30000,
                    }).done(function (data) {
                        console.log(data);
                        loadState += 30;
                        $("#loadingBar div").attr("aria-valuenow", loadState).css("width", loadState + "%")
                        resultData["Pilea"] = data.Pilea;
                        setPlantDetails("Pilea");
                        addDataToChart(data)
                    }).fail(function (data) {
                        console.error(data);
                        handleError("Error loading Pilea data.")
                    }),
                    $.ajax(url, {
                        data: JSON.stringify(inputDataDrachenbaum),
                        contentType: 'application/json',
                        type: 'POST',
                        timeout: 30000,
                    }).done(function (data) {
                        console.log(data);
                        loadState += 30;
                        $("#loadingBar div").attr("aria-valuenow", loadState).css("width", loadState + "%")
                        resultData["Drachenbaum"] = data.Drachenbaum;
                        setPlantDetails("Drachenbaum");
                        addDataToChart(data)
                    }).fail(function (data) {
                        console.error(data);
                        handleError("Error loading Drachenbaum data.")
                    }),
                    $.ajax(url, {
                        data: JSON.stringify(inputDataGoldfruchtpalme),
                        contentType: 'application/json',
                        type: 'POST',
                        timeout: 30000,
                    }).done(function (data) {
                        console.log(data);
                        loadState += 30;
                        $("#loadingBar div").attr("aria-valuenow", loadState).css("width", loadState + "%")
                        resultData["Goldfruchtpalme"] = data.Goldfruchtpalme;
                        setPlantDetails("Goldfruchtpalme");
                        addDataToChart(data)
                    }).fail(function (data) {
                        console.error(data);
                        handleError("Error loading Goldfruchtpalme data.")
                    }),
                ).then(function () {
                    $("#loadingBar").hide("slow")
                    $('#refreshButton').prop("disabled", false);

                });
            }

            $(function () {
                errorModal = new bootstrap.Modal(document.getElementById('errorModal'), {})
                const labels = last8Days();
                let delayed;
                Chart.defaults.font.family = "'-apple-system','BlinkMacSystemFont','Segoe UI','Roboto','Helvetica Neue','Arial','sans-serif','Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol'";
                Chart.defaults.font.size = 16;
                const ctx = document.getElementById('plantChart').getContext('2d');
                plantChart = new Chart(ctx, {
                    labels: labels,
                    type: 'line',
                    data: {
                        labels: labels,
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            yAxis: {
                                min: 0,
                                max: 100,
                                title: {
                                    display: true,
                                    text: "Soil moisture in %",
                                }
                            },
                        },
                        animations: {
                            y: {
                                easing: 'easeInOutElastic',
                                from: (ctx) => {
                                    if (ctx.type === 'data') {
                                        if (ctx.mode === 'default' && !ctx.dropped) {
                                            ctx.dropped = true;
                                            return 0;
                                        }
                                    }
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                labels: {
                                    //usePointStyle: true,
                                },
                            }
                        },
                    }
                });
                getPlantData();
                $('#refreshButton').click(function () {
                    getPlantData();
                });
            });


        </script>
    </main>
</body>

</html>